

<!DOCTYPE html>

	<html lang="en-US">

	<head>
		<meta charset="UTF-8">
		<meta http-equiv="x-ua-compatible" content="ie=edge">
		<meta name="viewport" content="width=device-width, minimum-scale=1.0">
		
			<title>Virtual Private Network (2) | r-pi</title>
		
		
			<meta name="description" content="Set up a VPN server with Wireguard">
		
		
			<meta name="keywords" content="Raspberry Pi, Privoxy, Squid, SquidGuard, Parental Control, Web Filter, backup, rsnapshot, vpn, openvpn">
		
		<link rel="icon" href="/favicon.ico" type="image/x-icon">
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:400,400i,500,500i,700,700i">
		<link rel="stylesheet" href="/dox-theme/assets/css/style.css">
		

<!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//stats.mizuki.ch/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '1']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->

	</head>
	<body>
		
			<div class="c-offcanvas">
				<div class="c-offcanvas__inner">
					
						<ul class="c-nav c-nav--stacked u-mx-auto">
							
								<li><a href="/">Homepage</a></li>
							
								<li><a href="/about">About</a></li>
							
								<li><a href="/blog">Emergency</a></li>
							
								<li><a href="/photo">Photo</a></li>
							
						</ul><!-- /.c-nav -->
					
					
						
							<a href="/projects" class="c-btn c-btn--md c-btn--gray u-text-md">
								Projects
								<div class="c-btn__icon">
									<i class="o-icon o-icon--code"></i>
								</div>
							</a>
						
					
				</div><!-- /.c-offcanvas__inner -->
			</div><!-- /.c-offcanvas -->
		

		
			<header class="c-header">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12">
							<div class="u-flex u-items-center">
								
									
										<p class="c-logo u-mb-0 js-logo">
											<a href="/" class="c-logo__link">r-pi</a>
										</p><!-- /.c-logo -->
									
								
								
									<div class="u-flex u-items-center u-ml-auto">
										
											<ul class="c-nav u-mb-0 u-hidden u-block@lg">
												
													
													<li class=""><a href="/">Homepage</a></li>
												
													
													<li class=""><a href="/about">About</a></li>
												
													
													<li class=""><a href="/blog">Emergency</a></li>
												
													
													<li class=""><a href="/photo">Photo</a></li>
												
											</ul><!-- /.c-nav -->
										
										
											<div class="u-ml-5 u-hidden u-block@lg">
												
													<a href="/projects" class="c-btn c-btn--md c-btn--gray u-text-md">
														Projects
														<div class="c-btn__icon">
															<i class="o-icon o-icon--code"></i>
														</div>
													</a>
												
											</div>
										
									</div>
								
								<button class="c-hamburger-icon c-hamburger-icon--slider js-hamburger-icon js-offcanvas-toggle u-ml-auto u-hidden@lg" type="button">
									<span class="c-hamburger-icon__box">
										<span class="c-hamburger-icon__inner"></span>
									</span><!-- /.c-hamburger-icon__box -->
								</button><!-- /.c-hamburger-icon -->
							</div>
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</header><!-- /.c-header -->
		







	
		<div class="c-hero u-bg-gray-30 u-pt-16 u-pb-10">
	
		<div class="o-container">
			<div class="o-row">
				<div class="o-col-8@lg o-col-7@xl">
					
						<h2 class="u-text-lg u-text-xl@sm">Wireguard VPN server</h2>
					
					
						<div class="u-h6">
							<p>Install a personal <span style="color:red">VPN server</span> with <span style="color:red">Wireguard</span>.</p>
						</div>
					
					
					
				</div><!-- /.o-col -->
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>




	<div class="u-pt-8 u-pb-5">
		<div class="o-container">
			<div class="o-row">
				
					<div class="o-col-8@lg o-col-7@xl">
						<div class="c-post u-mb-3@lg js-post">
							<p><em>Last update: <span style="color:red">2021.04.25</span></em></p>

<p>I have been using OpenVPN for some time now, always with full satisfaction. Recently, I decided to try an alternative called Wireguard. It is said to be faster, simpler and more secure than most other VPN solutions. I describe below how to install and configure vpn tunnels using this new tool. I have to say thet the process is pleasently easy.</p>

<p>First, update the system</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get upgrade <span class="nt">-y</span>
</code></pre></div></div>

<p>Install Wireguard</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>wireguard
</code></pre></div></div>

<p>Change directory as super user</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su
<span class="nb">cd</span> /etc/wireguard
<span class="nb">umask </span>077
</code></pre></div></div>

<p>Generate Server security keys</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wg genkey | <span class="nb">tee </span>server_private_key | wg pubkey <span class="o">&gt;</span> server_public_key
</code></pre></div></div>

<p>Generate Client security keys. Repeat as many time as needed (e.g. phone, tablet, laptop)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wg genkey | <span class="nb">tee </span>iPhone_private_key | wg pubkey <span class="o">&gt;</span> iPhone_public_key
</code></pre></div></div>

<p>Retrieve the <strong>Server</strong> Private/Public keys with the <code class="language-plaintext highlighter-rouge">cat</code> command</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>server_private_key
<span class="nv">ID4Ldxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class="o">=</span>
<span class="nb">cat </span>server_public_key
<span class="nv">UulJ9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class="o">=</span>
</code></pre></div></div>

<p>Retrieve the <strong>Client</strong> Private/Public keys with the <code class="language-plaintext highlighter-rouge">cat</code> command</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>iPhone_private_key
<span class="nv">IOrKgxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><span class="o">=</span>
<span class="nb">cat </span>iPhone_public_key
+gfhexxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<span class="o">=</span>
</code></pre></div></div>

<p>Create the <strong>Server</strong> configuration file</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano wg0.conf
</code></pre></div></div>

<p>Add</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Interface]
Address <span class="o">=</span> 10.9.0.1/24
PrivateKey <span class="o">=</span> insert server_private_key
ListenPort <span class="o">=</span> 51900
DNS <span class="o">=</span> 1.1.1.1

PostUp <span class="o">=</span> iptables <span class="nt">-A</span> FORWARD <span class="nt">-i</span> %i <span class="nt">-j</span> ACCEPT<span class="p">;</span> iptables <span class="nt">-A</span> FORWARD <span class="nt">-o</span> %i <span class="nt">-j</span> ACCEPT<span class="p">;</span> iptables <span class="nt">-t</span> nat <span class="nt">-A</span> POSTROUTING <span class="nt">-o</span> eth0 <span class="nt">-j</span> MASQUERADE
PostDown <span class="o">=</span> iptables <span class="nt">-D</span> FORWARD <span class="nt">-i</span> %i <span class="nt">-j</span> ACCEPT<span class="p">;</span> iptables <span class="nt">-D</span> FORWARD <span class="nt">-o</span> %i <span class="nt">-j</span> ACCEPT<span class="p">;</span> iptables <span class="nt">-t</span> nat <span class="nt">-D</span> POSTROUTING <span class="nt">-o</span> eth0 <span class="nt">-j</span> MASQUERADE

<span class="o">[</span>Peer]
<span class="c"># client1 - iPhone</span>
PublicKey <span class="o">=</span> insert client_public_key
AllowedIPs <span class="o">=</span> 10.9.0.2/32
PersistentkeepAlive <span class="o">=</span> 60
</code></pre></div></div>

<div class="callout callout--warning">
    <p><strong>Note</strong> You can have multiple peers if necessary. Each must be under the tag [Peer] with at least PublicKey and AllowedIPs. Obviously, each client will have its own public key and its own assigned IP</p>
</div>

<p>Next, create the <strong>Client</strong> configuration file</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano wg0-iPhone.conf
</code></pre></div></div>

<p>Add</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Interface]
Address <span class="o">=</span> 10.9.0.2/32
PrivateKey <span class="o">=</span> insert client_private_key
    
<span class="o">[</span>Peer]
PublicKey <span class="o">=</span> insert server_public_key
Endpoint <span class="o">=</span> your.publicdns.com::51900
AllowedIPs <span class="o">=</span> 0.0.0.0/0, ::/0
PersistentKeepalive <span class="o">=</span> 25
</code></pre></div></div>

<p>Enable so the wg0 will start on boot and set permissions</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl <span class="nb">enable </span>wg-quick@wg0
<span class="nb">chown</span> <span class="nt">-R</span> root:root /etc/wireguard/
<span class="nb">chmod</span> <span class="nt">-R</span> og-rwx /etc/wireguard/<span class="k">*</span> 
</code></pre></div></div>

<p>Type <code class="language-plaintext highlighter-rouge">exit</code></p>

<p>You can always start/stop Wireguard with the following commands</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>wg-quick up wg0
<span class="nb">sudo </span>wg-quick down wg0
</code></pre></div></div>

<p>Edit the <code class="language-plaintext highlighter-rouge">sysctl.conf</code> file</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano /etc/sysctl.conf
</code></pre></div></div>

<p>Find <code class="language-plaintext highlighter-rouge">net.ipv4.ip_forward=1</code> and uncomment</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net.ipv4.ip_forward<span class="o">=</span>1
</code></pre></div></div>

<p>Reboot and make sure the wg0 service is running with <code class="language-plaintext highlighter-rouge">ifconfig</code>. You should see the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wg0: <span class="nv">flags</span><span class="o">=</span>209&lt;UP,POINTOPOINT,RUNNING,NOARP&gt;  mtu 1420
        inet 10.9.0.1  netmask 255.255.255.0  destination 10.9.0.1
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  <span class="o">(</span>UNSPEC<span class="o">)</span>
        RX packets 99827  bytes 22086788 <span class="o">(</span>21.0 MiB<span class="o">)</span>
        RX errors 162  dropped 0  overruns 0  frame 162
        TX packets 250690  bytes 273049948 <span class="o">(</span>260.4 MiB<span class="o">)</span>
        TX errors 0  dropped 762 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<p>Now, let’s install <code class="language-plaintext highlighter-rouge">qrencode</code>. This tool will generate QR codes making the configuration of Wireguard on a mobile device super easy.</p>

<p>Install with the following 2commands</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>python-pip
</code></pre></div></div>

<p>then</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install </span>qrencode
</code></pre></div></div>

<p>now, as super user type the following to generate the QR code and scan it with your mobile phone</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>su
qrencode <span class="nt">-t</span> ansiutf8 &lt; /etc/wireguard/wg0-iPhone.conf
</code></pre></div></div>

<p>That’s it! Pretty easy, isn’t it.</p>

<p>Type the command below to see the state of your connection</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>wg
</code></pre></div></div>

<div class="callout callout--warning">
    <p><strong>Firewall</strong> If you are behind a firewall such as UFW, don't forget to open the port wireguard is listening to (51900/udp)</p>
</div>

<div class="callout callout--warning">
    <p><strong>Port Forward</strong> Don't forget to set port forwarding as necessary</p>
</div>

<div class="Reference"></div>

<h4 id="reference">Reference</h4>

<p><a href="https://tutox.fr/2020/02/07/installer-un-vpn-wireguard-sur-sa-raspberry-tuto/">https://tutox.fr/2020/02/07/installer-un-vpn-wireguard-sur-sa-raspberry-tuto/</a><br />
<a href="https://engineerworkshop.com/blog/how-to-set-up-wireguard-on-a-raspberry-pi/">https://engineerworkshop.com/blog/how-to-set-up-wireguard-on-a-raspberry-pi/</a><br />
<a href="https://www.sigmdel.ca/michel/ha/wireguard/wireguard_02_en.html">https://www.sigmdel.ca/michel/ha/wireguard/wireguard_02_en.html</a><br /></p>

							
	<div class="c-comments u-mt-8 u-mb-3">
		<div id="disqus_thread"></div>
		<script>
			/**
			 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			 */
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
				this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() {
				var d = document, s = d.createElement('script');

				s.src = 'https://lls.disqus.com/embed.js';

				s.setAttribute('data-timestamp', +new Date());
				(d.head || d.body).appendChild(s);
			})();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	</div><!-- /.c-comments -->


						</div><!-- /.c-post -->
					</div><!-- /.o-col -->
				
				
					<div class="o-col-3@lg o-offset-1@lg o-offset-2@xl">
						<ul class="c-page-nav u-sticky u-pin-t-6 u-mt-4 u-mt-1@lg u-mb-1 u-mb-4@lg">
							
							
								
									<li class="is-active">
										<a href="/documentation/parental_control/">
											<p class="c-page-nav__heading">Web Filter Proxy (kid safe)</p>
										</a>
									</li>
								
							
								
									<li class="is-active">
										<a href="/documentation/access_point/">
											<p class="c-page-nav__heading">Wireless Access Point (kid safe)</p>
										</a>
									</li>
								
							
								
									<li class="is-active">
										<a href="/documentation/backup/">
											<p class="c-page-nav__heading">Backup multiple r-pi with rsnapshot</p>
										</a>
									</li>
								
							
								
									<li class="is-active">
										<a href="/documentation/vpn-1/">
											<p class="c-page-nav__heading">Virtual Private Network (1)</p>
										</a>
									</li>
								
							
								
									<li class="is-active">
										<a href="/documentation/vpn-2/">
											<p class="c-page-nav__heading">Virtual Private Network (2)</p>
										</a>
									</li>
								
							
								
									<li>
										<a href="/documentation/web_server/">
											<p class="c-page-nav__heading">Web server (under construction)</p>
										</a>
									</li>
								
							
								
									<li>
										<a href="/documentation/nextcloud/">
											<p class="c-page-nav__heading">Nextcloud (under construction)</p>
										</a>
									</li>
								
							
						</ul><!-- /.c-page-nav -->
					</div><!-- /.o-col -->
				
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>




	<div class="u-bg-primary u-text-white u-pt-3 u-pt-4@sm u-pb-3 u-pb-4@sm">
		<div class="o-container">
			<div class="o-row">
				<div class="o-col-12 u-text-center">
					<div class="u-inline-block u-flex@sm">
						
						
							
							
							
						
							
							
							
						
							
							
							
						
							
							
							
								<a href="/documentation/vpn-1/" class="c-arrow-link c-arrow-link--prev u-mr-auto">Virtual Private Network (1)</a>
							
						
							
							
							
						
							
							
							
								<a href="/documentation/web_server/" class="c-arrow-link c-arrow-link--next u-ml-auto">Web server (under construction)</a>
							
						
							
							
							
						
					</div>
				</div><!-- /.o-col -->
			</div><!-- /.o-row -->
		</div><!-- /.o-container -->
	</div>




	

		
			<footer class="c-footer">
				<div class="o-container">
					<div class="o-row">
						<div class="o-col-12 u-mt-6 u-mt-8@md u-mb-4 u-mb-6@md">
							
								<p class="c-logo u-mb-1">
									r-pi
								</p><!-- /.c-logo -->
							
							
								<p>Copyright &copy; 2021. - r-pi <br>All rights reserved.</p>
							
						</div><!-- /.o-col -->
					</div><!-- /.o-row -->
				</div><!-- /.o-container -->
			</footer><!-- /.c-footer -->
		

		<script type="text/javascript" src="/dox-theme/assets/js/vendor/jquery-3.3.1.min.js"></script>
		<script type="text/javascript" src="/dox-theme/assets/js/scripts.min.js"></script>

		<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

</script>
	</body>
</html>


